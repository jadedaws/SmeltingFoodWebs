---
title: "Study Lakes main calculations and paper figures"
author: "J Dawson"
date: '2021-03-31'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Importing Data}
rm(list=ls())

library(naniar)
library(dplyr)
library(ggplot2)
library(readr)

###Github connection to McCann & Johnston dataset for CompleteIso with the BsM comparison lakes
data <- read_csv("../data/CompleteIsotopeswBsMCompLakes.csv")
data <- subset(data, select=-c(d13C_Cor, Site)) %>%
  filter(!grepl("Richardson Lk.", Water))
  
###Adding new lakes from Johnston
new_dat <- read_csv("../data/Dawson-Isotopes-2024Feb05.csv")
new_dat <- new_dat[-c(1),] %>%
  filter(!grepl("O", Check))

new_dat <- subset(new_dat, select=-c(FISH, REGION, YEAR, DAY, COMP, Tissue, Check, Comments)) %>%
          rename("SIASAM" = "SIA SAM",
               "Water" = "WBY",
               "d13C" = "Del 13C",
               "d15N" = "Del 15N",
               "C.N" = "C/N") %>%
          select(Water, TAXON, SIASAM, d13C, d15N, C.N, everything())

###Stitching
cols.num <- c("d13C","d15N", "C.N", "FLEN", "TLEN", "RWT")
new_dat[cols.num] <- sapply(new_dat[cols.num],as.numeric)
data <- bind_rows(data, new_dat)

rm(new_dat)
```

```{r Cleaning baseline data}
##Subsetting data for just baselines
base_data <- data %>%
  filter(grepl("EPH|ZOOP|PERI|MAYFLY|EPHEMERI|SNAIL|TRICHOPT|CLAM|DRAGFLY|CRAYFISH|CHIRO|AMPHIPOD|HEPTAGEN|CHAOBORUS", TAXON)) %>%
  mutate(TAXON = recode(TAXON, EPH='MAYFLY', EPHEMERI='MAYFLY', HEPTAGEN='MAYFLY'))

#mean d13C, d15N, sd by baseline
base_data <- base_data %>%
  group_by(Water, TAXON) %>%
  subset(TAXON %in% c("CLAM", "MAYFLY", "ZOOP","SNAIL","AMPHIPOD")) %>%
  summarise(mean_d13C = mean(d13C), mean_d15N = mean(d15N), sd_d13C = sd(d13C), sd_d15N = sd(d15N))

#make dataset w columns for d13C, d15N by baseline
library(reshape2)
d13C <- dcast(data = base_data, formula = Water ~ TAXON, value.var = "mean_d13C")
d13C <- d13C %>% 
        rename("d13C_clam" = "CLAM",
               "d13C_eph" = "MAYFLY",
               "d13C_zoop" = "ZOOP",
               "d13C_snail" = "SNAIL",
               "d13C_amph" = "AMPHIPOD")

d15N <- dcast(data = base_data, formula = Water ~ TAXON, value.var = "mean_d15N")
d15N <- d15N %>% 
        rename("d15N_clam" = "CLAM",
               "d15N_eph" = "MAYFLY",
               "d15N_zoop" = "ZOOP",
               "d15N_snail" = "SNAIL",
               "d15N_amph" = "AMPHIPOD")

base_data <- merge(d13C, d15N, by = "Water")

###Some ref lakes do not have zoop baseline, so combine Zoop and Clam column for it (pel)
##use coalesce()
base_data$d13C_pel <- unite(base_data$d13C_clam,base_data$d13C_zoop, sep="_", na.rm=T)


base_data$d13C_pel[base_data$Water == "Tadenac Lk."] <- -27.796
base_data$d15N_pel <- base_data$d15N_zoop
base_data$d15N_pel[base_data$Water == "Tadenac Lk."] <- 3.595

base_data <- subset(base_data, select=-c(d13C_clam, d15N_clam))

data <- merge(data, base_data, by = c("Water"))

rm(base_data)
```

```{r Tidying df}
##Remove baseline entries as rows + site column
data <- subset(data, select=-c(Site,SIZE))

data <- data %>%
  filter(!grepl("EPH|ZOOP|PERI|MAYFLY|HEPTAGEN|EPHEMERI|TRICHOPT|CRAYFISH|CLAM|SNAIL", TAXON))

##Renaming some of the fish species to match each other
data$TAXON[data$TAXON == "COSHIN"] <- "COSHINER"
data$TAXON[data$TAXON == "NP"] <- "NPIKE"

##Adding column for isoscape/biplot colouration
data$colour <- "All other species"
data$colour[data$TAXON == "SMB"] <- "SMB"
data$colour[data$TAXON == "YPERCH"] <- "YPERCH"
  
```

```{r Proportion Littoral calculation}

#eph (L) ; zoop/clam (P)
data$prop_litt <- (data$d13C - data$d13C_pel)/(data$d13C_eph - data$d13C_pel)
data<- data[!is.na(data$prop_litt),]
hist(data$prop_litt)

#adjusted (<0 and 100<)
data$adjprop_litt <- NA
data$adjprop_litt = data$prop_litt
data$adjprop_litt[data$prop_litt>1] <- 1.00
data$adjprop_litt[data$prop_litt<0] <- 0.00
hist(data$adjprop_litt)
```

```{r Summarizing prop littoral for bigdat}
#data summary for creating 'bigdat'
data_sum <- data %>% group_by(Water, TAXON) %>%
  summarise(mean.pl = mean(prop_litt), sd.pl = sd(prop_litt), mean.adjpl = mean(adjprop_litt), sd.adjpl = sd(adjprop_litt))
#create master data frame w/ all baseline C/Ns, mean prop littoral
bigdat <- merge(data, data_sum, by = c("Water", "TAXON"))

#Filter for lakes of interest, remove baselines, add in size data (FLEN/TLEN)
size_dat <- read_csv("../data/LCAR_SIA_Database.csv")
size_td <- read_csv("../data/Tom-ExtraLakes-Isotopes-2021Apr09.csv")
size_td <- size_td %>%
  filter(grepl("Tadenac", WBY)) %>%
  filter(!grepl("MAYFLY|CLAM|EPHEMERI", TAXON))
  
size_rc <- read_csv("../data/RichardsonL_SIA-data.csv")
size_rc <- size_rc %>%
  filter(grepl("Richardson", Lake_Name)) %>%
  filter(!grepl("Baseline", Trophic_Level))

#Remove to have only necessary fields, renaming to common "SIASAM", removing NAs
size_dat<-size_dat[,c(1,9:11)]
size_dat<-size_dat[-c(172:175),]

size_td <- size_td[,c(1,9:11)]
size_td <- size_td %>%
  rename(SIASAM = `SIA SAM`)

size_rc <- size_rc[,c(5,15,27:29)]
size_rc <- size_rc %>%
  rename(SIASAM = SI_ID)
###Richardson SIASAM values not included in 'bigdat' so trying to stitch using d13C_Cor

##stitching data together
sizedat1 <- rbind(size_dat, size_td)

test <- merge(bigdat, sizedat1, by = "SIASAM")
test2 <- merge(bigdat, size_rc, by = "d13C_Cor")  ###rearrange to match test and remove duplicate SIASAM column

test2 <- test2[,-c(4)]
test2 <- test2 %>%
  rename(SIASAM = SIASAM.y)

test2 <- test2[,c(20,2:6,1,7:19,21:23)]

#stitching together to update 'bigdat'
bigdat <- rbind(test,test2)
bigdat[,21:23] <- sapply(bigdat[,21:23], as.numeric)

rm(data_sum,size_rc,size_td,size_dat,sizedat1,test,test2)

```

```{r Trophic Position calculation}

### TWO BASELINE TP CALCULATION ###
# two baseline
bigdat$tp_2 <- 2 + ((bigdat$d15N - ((bigdat$d15N_pel*(1 - bigdat$prop_litt)) + (bigdat$d15N_eph*bigdat$prop_litt)))/3.4)

#summarize data for plots
data_sum_tp <- bigdat %>% group_by(Water, TAXON) %>%
  summarise(mean.tp2 = mean(tp_2), sd.tp2 = sd(tp_2))

```

```{r Proportion Littoral plot - CJFAS Fig 4}

smbyplab <- c("Smallmouth bass", "Yellow perch")

##MEAN +/- sd
unadjpl <- ggplot(subset(bigdat, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.pl, colour = TAXON, group = TAXON)) +
  geom_point(show.legend = FALSE) +
  geom_errorbar(aes(ymax = mean.pl + sd.pl, ymin = mean.pl - sd.pl), show.legend = FALSE) +
  xlab("Fish species") +
  ylab("Mean proportion littoral energy usage +/- sd") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw()

#plot(unadjpl)

##CJFAS Fig 4 - Adj Prop Littoral##
adjpl <- 
  ggplot(subset(bigdat, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.adjpl, colour = TAXON, group = TAXON)) +
  geom_point(show.legend = FALSE) +
  geom_errorbar(aes(ymax = mean.adjpl + sd.adjpl, ymin = mean.adjpl - sd.adjpl), show.legend = FALSE) +
  xlab("Fish species") +
  ylab("Mean proportion littoral energy +/- sd (adjusted)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() 

adjpl + geom_point(data = subset(bigdat, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = adjprop_litt), shape = 1)

```

```{r ANOVA/ANCOVA proportion littoral and TP w/ length}
library(emmeans)

#######################
###  PROP LITTORAL  ###
#######################

##SMB adj prop littoral data
bigdat$TAXON <- as.factor(bigdat$TAXON)
smb_adjPL <- bigdat %>%
  filter(grepl("SMB", TAXON))

###ANOVA w/ only sig. variables - FLEN insig.
smb_pl_aov<-lm(adjprop_litt ~ Water, data = smb_adjPL)
anova(smb_pl_aov)
###contrasts
smb_pl_em<-emmeans(smb_pl_aov, pairwise ~ Water, adjust = "none")
smb_pl_em

x<-as.data.frame(summary(smb_pl_em)$emmeans)

SMB_PL<-ggplot(x, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("SMB Prop Litt +/- 95% CI") +  
  theme_bw()

##YP adj prop littoral data
yp_adjPL <- bigdat %>%
  filter(grepl("YP", TAXON))

###ANOVA w/ only sig. variables - TLEN insig. Used TLEN because more data.
yp_pl_aov<-lm(adjprop_litt ~ Water*TLEN, data = yp_adjPL)
anova(yp_pl_aov)

###ANCOVA w/ TLEN interaction
YP_PLTLEN<-emmeans(yp_pl_aov, pairwise ~ Water, adjust = "none")
YP_PLTLEN

x1<-as.data.frame(summary(YP_PLTLEN)$emmeans)

#plot for PL adj
YP_PL<-ggplot(x1, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("YP Prop Litt  +/- 95% CI") +  
  theme_bw()

#####################
###      TP       ###
#####################
##TP + size correction

##SMB
smb_tp_aov<- lm(tp_2~Water*TLEN, data=bigdat, subset=(TAXON=="SMB"))
anova(smb_tp_aov)

smb_tp<-emmeans(smb_tp_aov, pairwise ~ Water, adjust = "none")
smb_tp

x2<-as.data.frame(summary(smb_tp)$emmeans)

#plot for SMB TP with body size correction - need to force Y scale the same
SMB_TP_size<-ggplot(x2, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("SMB TP +/- 95% CI") +  
  theme_bw()

#YP
yp_tp_aov<- lm(tp_2~Water*TLEN, data=bigdat, subset=(TAXON=="YPERCH"))
anova(yp_tp_aov)

yp_tp<-emmeans(yp_tp_aov, pairwise ~ Water, adjust = "none")
yp_tp

x3<-as.data.frame(summary(yp_tp)$emmeans)

#plot for YP TP with body size correction - need to force Y scale the same
YP_TP_size<-ggplot(x3, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("YP TP +/- 95% CI") +  
  theme_bw()

plot_grid(SMB_PL, YP_PL, SMB_TP_size, YP_TP_size, labels = "AUTO")

```
##Range info for TP and PL needed for CJFAS body text


```{r Trophic Position Plot - CJFAS Fig 2}

##CJFAS FIGURE 2 - MIXED TP ##
smbyplab <- c("Smallmouth bass", "Yellow perch")

TPFig<-ggplot(subset(data_sum_tp, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = mean.tp2, colour = TAXON, group = TAXON)) +
  geom_point() +
  geom_errorbar(aes(ymax = mean.tp2 + sd.tp2, ymin = mean.tp2 - sd.tp2)) +
  xlab("Fish species") +
  ylab("Mean Trophic Position +/- sd (two end mixed)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text())

TPFig + geom_point(data = subset(bigdat, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = tp_2), shape = 1)

```

```{r SEA Ellipse plot - CJFAS Fig 3 Isoscape plot}

#CJFAS Figure 3 - ellipses
##adding colour for SMB + YP only and symbols for taxon
CJFAS_CN<-ggplot(data, aes(x = d13C, y = d15N, shape = TAXON, colour = colour, group = interaction(Water, TAXON))) +
  geom_point() +
  stat_ellipse(type = "norm", level = 0.4, lwd = 1.5) +
  theme_classic(base_size = 14) +
  facet_wrap(~Water)

CJFAS_CN + 
  scale_color_manual(values=c("#999999", "#009E73", "#D55E00")) +
  scale_shape_manual(values = c(1, 2, 3, 4, 17, 6, 7, 8, 9, 10, 11, 12, 25, 14, 15, 16, 17, 5, 0, 20))


```

```{r TLEN plot Fig X and mean TLEN +/- sd calculation Table 1}
TLENdat <- bigdat %>%
  group_by(Water, TAXON) %>%
  summarise(TLEN_mean = mean(TLEN), TLEN_sd = sd(TLEN))

bigdat <- merge(bigdat, TLENdat, by = c("Water", "TAXON"))

TLENFig<-ggplot(subset(bigdat, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = TLEN_mean, colour = TAXON, group = TAXON)) +
  geom_point() +
  geom_errorbar(aes(ymax = TLEN_mean + TLEN_sd, ymin = TLEN_mean - TLEN_sd)) +
  xlab("Fish species") +
  ylab("Mean Total Length +/- sd (mm)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text())

TLENFig + geom_point(data = subset(bigdat, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = TLEN), shape = 1)

```

#########################################
#####     SUPPLEMENTAL FIGURES      #####
#########################################

```{r S15 - C:N Ratio (A), Fultons Index (B)}
#################
##  C:N MEAN   ##
#################

##SUBSETTING DATA
sumCN <- bigdat %>%
  group_by(Water, TAXON) %>%
  summarise(mean.CN = mean(C.N), sd.CN = sd(C.N), mean.flen = mean(FLEN), sd.flen = sd(FLEN), mean.rwt = mean(RWT), sd.rwt = sd(RWT), mean.tlen = mean(TLEN), sd.tlen = sd(TLEN))

#PLOT
ggplot(subset(sumCN, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.CN, colour = TAXON, group = TAXON)) +
  geom_point() +
  scale_color_grey(start= 0.1, end = 0.5) +
  geom_errorbar(aes(ymax = mean.CN + sd.CN, ymin = mean.CN - sd.CN)) +
  xlab("Smallmouth bass and Yellow perch communities by Lake") +
  ylab("Mean C:N Ratio +/- sd") +
  scale_y_continuous() +
  scale_x_discrete() +
  facet_wrap(~Water)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45))

#C:N ANOVA
data_CN <- bigdat[,c(1:3,6)]
data_CN_YP <- data_CN[data_CN$TAXON == "YPERCH",]
data_CN_SMB <- data_CN[data_CN$TAXON == "SMB",]

yp_cn_aov<-aov(C.N ~ Water, data = data_CN_YP)
summary(yp_cn_aov)
TukeyHSD(yp_cn_aov, which = "Water")

smb_cn_aov<-aov(C.N ~ Water, data = data_CN_SMB)
summary(smb_cn_aov)
TukeyHSD(smb_cn_aov, which = "Water")

#################
##   FI MEAN   ##
#################
#add FI to 'bigdat'
bigdat$FI <- NA
bigdat$FI <- ifelse(is.na(bigdat$FLEN), (bigdat$RWT/(bigdat$TLEN^3)) * 100000, (bigdat$RWT/(bigdat$FLEN^3)) * 100000)

##SUBSETTING DATA
FIdat <- bigdat[!is.na(bigdat$FI),]
sumFI <- FIdat %>%
  group_by(Water, TAXON) %>%
  summarise(mean.FI = mean(FI), sd.FI = sd(FI))

ggplot(subset(sumFI, TAXON %in% c("SMB","YPERCH")), aes(x = TAXON, y = mean.FI, colour = TAXON, group = TAXON)) +
  geom_point() +
  scale_color_grey(start = 0.1, end = 0.5) +
  geom_errorbar(aes(ymax = mean.FI + sd.FI, ymin = mean.FI - sd.FI)) +
  xlab("Smallmouth bass and Yellow perch communities by Lake") +
  ylab("Mean Fulton's Index +/- sd") +
  scale_y_continuous() +
  scale_x_discrete() +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45))

#FI ANOVA
#subsetting for FI by spp.
data_FI <- bigdat[,c(1:3,27)]
data_FI_YP <- data_FI[data_FI$TAXON == "YPERCH",]
data_FI_SMB <- data_FI[data_FI$TAXON == "SMB",]

yp_fi_aov<-aov(FI ~ Water, data = data_FI_YP)
summary(yp_fi_aov)
TukeyHSD(yp_fi_aov, which = "Water")

smb_fi_aov<-aov(FI ~ Water, data = data_FI_SMB)
summary(smb_fi_aov)
TukeyHSD(smb_fi_aov, which = "Water")

```

```{r S14 - Adj vs Unadj Prop Littoral}
##CJFAS Supplemental Fig adj vs unadj PL##
library(cowplot)
plot_grid(unadjpl, adjpl, labels = "AUTO")
```
