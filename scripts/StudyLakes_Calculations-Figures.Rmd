---
title: "Study Lakes main calculations and paper figures"
author: "J Dawson"
date: '2021-03-31'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Importing Data}
rm(list=ls())

library(naniar)
library(dplyr)
library(ggplot2)
library(readr)

###Github connection to McCann & Johnston dataset for CompleteIso with the BsM comparison lakes
data <- read_csv("../data/Dawson-Isotopes-StudyLakes.csv")

###Adding new lakes from Johnston
new_dat <- read_csv("../data/Dawson-Isotopes-2024Feb06.csv")

new_dat <- subset(new_dat, select=-c(FISH, REGION, YEAR, DAY, COMP, Tissue, Check, Comments)) %>%
          rename("SIASAM" = "SIA SAM",
               "Water" = "WBY",
               "d13C" = "Del 13C",
               "d15N" = "Del 15N",
               "C.N" = "C/N") %>%
          select(Water, TAXON, SIASAM, d13C, d15N, C.N, everything())
new_dat$Water[new_dat$Water == "Manitou-2"] <- "Manitou"

###Stitching
cols.num <- c("d13C","d15N", "C.N", "FLEN", "TLEN", "RWT")
new_dat[cols.num] <- sapply(new_dat[cols.num],as.numeric)
data <- bind_rows(data, new_dat)
data<- data[!is.na(data$d13C),]

rm(new_dat)
```

```{r Cleaning baseline data}
##Subsetting data for just baselines
base_data <- data %>%
  filter(grepl("EPH|ZOOP|PERI|MAYFLY|EPHEMERI|SNAIL|CLAM|CRAYFISH|AMPHIPOD|HEPTAGEN", TAXON)) %>%
  mutate(TAXON = recode(TAXON, EPH='MAYFLY', EPHEMERI='MAYFLY', HEPTAGEN='MAYFLY'))

#mean d13C, d15N, sd by baseline
base_data <- base_data %>%
  group_by(Water, TAXON) %>%
  subset(TAXON %in% c("CLAM", "MAYFLY", "ZOOP","SNAIL","AMPHIPOD")) %>%
  summarise(mean_d13C = mean(d13C), mean_d15N = mean(d15N), sd_d13C = sd(d13C), sd_d15N = sd(d15N))

#make dataset w columns for d13C, d15N by baseline
library(reshape2)
d13C <- dcast(data = base_data, formula = Water ~ TAXON, value.var = "mean_d13C")
d13C <- d13C %>% 
        rename("d13C_clam" = "CLAM",
               "d13C_eph" = "MAYFLY",
               "d13C_zoop" = "ZOOP",
               "d13C_snail" = "SNAIL",
               "d13C_amph" = "AMPHIPOD")

d15N <- dcast(data = base_data, formula = Water ~ TAXON, value.var = "mean_d15N")
d15N <- d15N %>% 
        rename("d15N_clam" = "CLAM",
               "d15N_eph" = "MAYFLY",
               "d15N_zoop" = "ZOOP",
               "d15N_snail" = "SNAIL",
               "d15N_amph" = "AMPHIPOD")

base_data <- merge(d13C, d15N, by = "Water")

###Some ref lakes do not have zoop baseline, so combine Zoop and Clam column for it (pel)
base_data$d13C_pel <- coalesce(base_data$d13C_clam,base_data$d13C_zoop)
base_data$d15N_pel <- coalesce(base_data$d15N_clam,base_data$d15N_zoop)
base_data$d13C_lit <- coalesce(base_data$d13C_eph,base_data$d13C_snail)
base_data$d15N_lit <- coalesce(base_data$d15N_eph,base_data$d15N_snail)

base_data <- subset(base_data, select=c(Water, d13C_pel, d15N_pel, d13C_lit, d15N_lit))
data<-left_join(data,base_data,keep=F)
rm(d13C, d15N, base_data)

##Remove baseline entries
data <- data %>%
  filter(!grepl("EPH|ZOOP|PERI|MAYFLY|HEPTAGEN|EPHEMERI|CRAYFISH|CLAM|SNAIL|AMPHIPOD", TAXON))

##Combining TLEN and FLEN for common length field
data$length <- coalesce(data$TLEN,data$FLEN)
```

```{r Proportion Littoral calculation}
data$p_lit <- (data$d13C - data$d13C_pel)/(data$d13C_lit - data$d13C_pel)

#rough plotting
hist(subset(data$p_lit, data$TAXON %in% c("SMB","YPERCH")))

smbyp_CN<-ggplot(subset(data, TAXON %in% c("SMB", "YPERCH")), aes(x = d13C, y = d15N, colour = TAXON, group = TAXON)) +
  geom_point(show.legend = FALSE) +
  facet_wrap(~Water)
smbyp_CN + geom_point(aes(x = d13C_lit, y = d15N_lit, colour = "littoral")) +
  geom_point(aes(x = d13C_pel, y = d15N_pel, colour = "pelagic"))

#adjusted (<0 and 100<)
data$adjp_lit <- NA
data$adjp_lit = data$p_lit
data$adjp_lit[data$p_lit>1] <- 1.00
data$adjp_lit[data$p_lit<0] <- 0.00
hist(subset(data$adjp_lit, data$TAXON %in% c("SMB", "YPERCH")))

rm(smbyp_CN)
```

```{r Summarizing prop littoral for data}
#data summary for creating 'data'
data_sum <- data %>% group_by(Water, TAXON) %>%
  summarise(mean.pl = mean(p_lit), sd.pl = sd(p_lit), mean.adjpl = mean(adjp_lit), sd.adjpl = sd(adjp_lit))
#add to df
data <- merge(data, data_sum, by = c("Water", "TAXON"))

rm(data_sum)
```

```{r Trophic Position calculation}
# two baseline
data$tp_2 <- 2 + ((data$d15N - ((data$d15N_pel*(1 - data$p_lit)) + (data$d15N_lit*data$p_lit)))/3.4)

#summarize tp by species
data_sum_tp <- data %>% group_by(Water, TAXON) %>%
  summarise(mean.tp2 = mean(tp_2), sd.tp2 = sd(tp_2))
#add to df
data <- merge(data, data_sum_tp, by = c("Water", "TAXON"))

rm(data_sum_tp)
```

```{r ANOVA/ANCOVA proportion littoral and TP w/ length}
library(emmeans)
library(cowplot)

#######################
###  PROP LITTORAL  ###
#######################
library(ggpubr)
library(multcomp)
data$TAXON <- as.factor(data$TAXON)

#######
# SMB #
#######
#ANOVA w/ only sig. variables - length significant interaction
smb_pl_mod<- lm(adjp_lit~Water*length, data=data, subset=(TAXON=="SMB"))
anova(smb_pl_mod)
#contrasts - use '|' ?
smb_pl_em<-emmeans(smb_pl_mod, pairwise ~ Water|length, adjust = "none")
smb_pl_em

x<-as.data.frame(summary(smb_pl_em)$emmeans)

#test letters - fail
#mod_means <- multcomp::cld(object = smb_pl_em$emmeans,Letters = letters)


#plot
SMB_PL_length<-ggplot(x, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("SMB P.Lit Water*length +/- 95% CI") +  
  theme_bw()
#SMB_PL_length + geom_pwc(aes(group = Water), tip.length = 0, method = "emmeans", label = "p.format", bracket.nudge.y = -0.08)

########
## YP ##
########
#ANOVA w/ only sig. variables - length significant. 
yp_pl_mod<- lm(adjp_lit~Water+length, data=data, subset=(TAXON=="YPERCH"))
anova(yp_pl_mod)
#ANCOVA w/ length interaction + contrasts
YP_PL<-emmeans(yp_pl_mod, pairwise ~ Water, adjust = "none")
YP_PL

x1<-as.data.frame(summary(YP_PL)$emmeans)

#plot
YP_PL_length<-ggplot(x1, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("YP P.Lit Water+length +/- 95% CI") +  
  theme_bw()

#####################
###      TP       ###
#####################

#######
# SMB #
#######
smb_tp_mod<- lm(tp_2~Water + length, data=data, subset=(TAXON=="SMB"))
anova(smb_tp_mod)

smb_tp<-emmeans(smb_tp_mod, pairwise ~ Water, adjust = "none")
smb_tp

x2<-as.data.frame(summary(smb_tp)$emmeans)

#plot - need to force Y scale the same
SMB_TP_size<-ggplot(x2, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("SMB TP Water+length +/- 95% CI") +  
  theme_bw()

########
## YP ##
########
yp_tp_mod<- lm(tp_2~Water+length, data=data, subset=(TAXON=="YPERCH"))
anova(yp_tp_mod)

yp_tp<-emmeans(yp_tp_mod, pairwise ~ Water, adjust = "none")
yp_tp

x3<-as.data.frame(summary(yp_tp)$emmeans)

#plot - need to force Y scale the same
YP_TP_size<-ggplot(x3, aes(x=Water, y=emmean))+
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=0.2)+
  geom_point()+
  ylab("YP TP +/- 95% CI") +  
  theme_bw()

##4 panel plot
plot_grid(SMB_PL_length, YP_PL, SMB_TP_size, YP_TP_size, labels = "AUTO")

```
##Range info for TP and PL needed for CJFAS body text

```{r Proportion Littoral plot - CJFAS Fig 4}

smbyplab <- c("Smallmouth bass", "Yellow perch")

##MEAN +/- sd
unadjpl <- ggplot(subset(data, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.pl, colour = TAXON, group = TAXON)) +
  geom_point(show.legend = FALSE) +
  geom_errorbar(aes(ymax = mean.pl + sd.pl, ymin = mean.pl - sd.pl), show.legend = FALSE) +
  xlab("Fish species") +
  ylab("Mean proportion littoral energy usage +/- sd") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw()

unadjpl + geom_point(data = subset(data, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = p_lit), shape = 1)

##CJFAS Fig 4 - Adj Prop Littoral##
adjpl <- ggplot(subset(data, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.adjpl, colour = TAXON, group = TAXON)) +
  geom_point(show.legend = FALSE) +
  geom_errorbar(aes(ymax = mean.adjpl + sd.adjpl, ymin = mean.adjpl - sd.adjpl), show.legend = FALSE) +
  xlab("Fish species") +
  ylab("Mean proportion littoral energy +/- sd (adjusted)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() 

adjpl + geom_point(data = subset(data, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = adjp_lit), shape = 1)

```

```{r Trophic Position Plot - CJFAS Fig 2}

##CJFAS FIGURE 2 - MIXED TP ##
smbyplab <- c("Smallmouth bass", "Yellow perch")

TPFig<-ggplot(subset(data_sum_tp, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = mean.tp2, colour = TAXON, group = TAXON)) +
  geom_point() +
  geom_errorbar(aes(ymax = mean.tp2 + sd.tp2, ymin = mean.tp2 - sd.tp2)) +
  xlab("Fish species") +
  ylab("Mean Trophic Position +/- sd (two end mixed)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text())

TPFig + geom_point(data = subset(data, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = tp_2), shape = 1)

```

```{r SEA Ellipse plot - CJFAS Fig 3 Isoscape plot}
##Renaming some of the fish species to match each other
#need to do for new fish spc
data$TAXON[data$TAXON == "COSHIN"] <- "COSHINER"
data$TAXON[data$TAXON == "NP"] <- "NPIKE"

##Adding column for isoscape/biplot colouration
data$colour <- "All other species"
data$colour[data$TAXON == "SMB"] <- "SMB"
data$colour[data$TAXON == "YPERCH"] <- "YPERCH"

#CJFAS Figure 3 - ellipses
##adding colour for SMB + YP only and symbols for taxon
CJFAS_CN<-ggplot(data, aes(x = d13C, y = d15N, shape = TAXON, colour = colour, group = interaction(Water, TAXON))) +
  geom_point() +
  stat_ellipse(type = "norm", level = 0.4, lwd = 1.5) +
  theme_classic(base_size = 14) +
  facet_wrap(~Water)

#need to change colour values
CJFAS_CN + 
  scale_color_manual(values=c("#999999", "#009E73", "#D55E00")) +
  scale_shape_manual(values = c(1, 2, 3, 4, 17, 6, 7, 8, 9, 10, 11, 12, 25, 14, 15, 16, 17, 5, 0, 20))


```

```{r TLEN plot Fig X and mean TLEN +/- sd calculation Table 1}
TLENdat <- data %>%
  group_by(Water, TAXON) %>%
  summarise(TLEN_mean = mean(TLEN), TLEN_sd = sd(TLEN))

data <- merge(data, TLENdat, by = c("Water", "TAXON"))

TLENFig<-ggplot(subset(data, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = TLEN_mean, colour = TAXON, group = TAXON)) +
  geom_point() +
  geom_errorbar(aes(ymax = TLEN_mean + TLEN_sd, ymin = TLEN_mean - TLEN_sd)) +
  xlab("Fish species") +
  ylab("Mean Total Length +/- sd (mm)") +
  scale_y_continuous() +
  scale_x_discrete(labels = smbyplab, guide = guide_axis(n.dodge=2)) +
  scale_colour_manual(labels = c("Smallmouth bass", "Yellow perch"), values = c("black", "grey")) +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text())

TLENFig + geom_point(data = subset(data, TAXON %in% c("YPERCH", "SMB")), aes(x = TAXON, y = TLEN), shape = 1)

```

#########################################
#####     SUPPLEMENTAL FIGURES      #####
#########################################

```{r S15 - C:N Ratio (A), Fultons Index (B)}
#################
##  C:N MEAN   ##
#################

##SUBSETTING DATA
sumCN <- data %>%
  group_by(Water, TAXON) %>%
  summarise(mean.CN = mean(C.N), sd.CN = sd(C.N), mean.flen = mean(FLEN), sd.flen = sd(FLEN), mean.rwt = mean(RWT), sd.rwt = sd(RWT), mean.tlen = mean(TLEN), sd.tlen = sd(TLEN))

#PLOT
ggplot(subset(sumCN, TAXON %in% c("SMB", "YPERCH")), aes(x = TAXON, y = mean.CN, colour = TAXON, group = TAXON)) +
  geom_point() +
  scale_color_grey(start= 0.1, end = 0.5) +
  geom_errorbar(aes(ymax = mean.CN + sd.CN, ymin = mean.CN - sd.CN)) +
  xlab("Smallmouth bass and Yellow perch communities by Lake") +
  ylab("Mean C:N Ratio +/- sd") +
  scale_y_continuous() +
  scale_x_discrete() +
  facet_wrap(~Water)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45))

#C:N ANOVA
data_CN <- data[,c(1:3,6)]
data_CN_YP <- data_CN[data_CN$TAXON == "YPERCH",]
data_CN_SMB <- data_CN[data_CN$TAXON == "SMB",]

yp_cn_aov<-aov(C.N ~ Water, data = data_CN_YP)
summary(yp_cn_aov)
TukeyHSD(yp_cn_aov, which = "Water")

smb_cn_aov<-aov(C.N ~ Water, data = data_CN_SMB)
summary(smb_cn_aov)
TukeyHSD(smb_cn_aov, which = "Water")

#################
##   FI MEAN   ##
#################
#add FI to 'data'
data$FI <- NA
data$FI <- ifelse(is.na(data$FLEN), (data$RWT/(data$TLEN^3)) * 100000, (data$RWT/(data$FLEN^3)) * 100000)

##SUBSETTING DATA
FIdat <- data[!is.na(data$FI),]
sumFI <- FIdat %>%
  group_by(Water, TAXON) %>%
  summarise(mean.FI = mean(FI), sd.FI = sd(FI))

ggplot(subset(sumFI, TAXON %in% c("SMB","YPERCH")), aes(x = TAXON, y = mean.FI, colour = TAXON, group = TAXON)) +
  geom_point() +
  scale_color_grey(start = 0.1, end = 0.5) +
  geom_errorbar(aes(ymax = mean.FI + sd.FI, ymin = mean.FI - sd.FI)) +
  xlab("Smallmouth bass and Yellow perch communities by Lake") +
  ylab("Mean Fulton's Index +/- sd") +
  scale_y_continuous() +
  scale_x_discrete() +
  facet_wrap(~Water)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45))

#FI ANOVA
#subsetting for FI by spp.
data_FI <- data[,c(1:3,27)]
data_FI_YP <- data_FI[data_FI$TAXON == "YPERCH",]
data_FI_SMB <- data_FI[data_FI$TAXON == "SMB",]

yp_fi_aov<-aov(FI ~ Water, data = data_FI_YP)
summary(yp_fi_aov)
TukeyHSD(yp_fi_aov, which = "Water")

smb_fi_aov<-aov(FI ~ Water, data = data_FI_SMB)
summary(smb_fi_aov)
TukeyHSD(smb_fi_aov, which = "Water")

```

```{r S14 - Adj vs Unadj Prop Littoral}
##CJFAS Supplemental Fig adj vs unadj PL##
library(cowplot)
plot_grid(unadjpl, adjpl, labels = "AUTO")
```
